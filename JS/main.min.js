function OnReloadClick(){location.reload()}function SendAsync(n){return __awaiter(this,void 0,void 0,function*(){return new Promise((t,i)=>{n.onreadystatechange=function(){switch(n.readyState){case 2:(n.status<200||300<=n.status)&&i(n.statusText);break;case 4:200<=n.status&&n.status<300&&t(!0)}n.readyState===4},n.send()})})}function AttachCanceller(n){var t=[undefined,undefined];return t[1]=new Promise((i,r)=>__awaiter(this,void 0,void 0,function*(){t[0]=()=>{i&&(i([!1,null]),i=null,r=null)};try{var u=yield n;i&&(i([!0,u]),i=null,r=null)}catch(f){r&&(r(f),i=null,r=null)}})),t}function DOMEventsAsync(n){return[new Promise(t=>{n.readyState==="interactive"||n.readyState==="complete"?t(null):n.addEventListener("DOMContentLoaded",n=>{t(n)})}),new Promise(t=>{n.readyState==="complete"?t(null):window.addEventListener("load",n=>{t(n)})})]}function EventAsync(n,t){return console.info(`${n.nodeName}:${t}:START`),new Promise(i=>{var r=u=>{i(u),n.removeEventListener(t,r),console.info(`${n.nodeName}:${t}:DONE`)};addEventListener(t,r)})}function DoEvents(){return new Promise(n=>{setTimeout(()=>n(!0),0)})}var __awaiter=this&&this.__awaiter||function(n,t,i,r){function u(n){return n instanceof i?n:new i(function(t){t(n)})}return new(i||(i=Promise))(function(i,f){function o(n){try{e(r.next(n))}catch(t){f(t)}}function s(n){try{e(r["throw"](n))}catch(t){f(t)}}function e(n){n.done?i(n.value):u(n.value).then(o,s)}e((r=r.apply(n,t||[])).next())})},MoveState;class LoadManager{constructor(){this.Listeners=[];this.PreUnLoadFuncs=[];this.AfterUnLoadFuncs=[];this._IsReady=!1;this._IsLoaded=!1}static Init(){return __awaiter(this,void 0,void 0,function*(){window.addEventListener("load",()=>console.info("window.onload"));var n=yield DOMEventsAsync(document);yield DoEvents();yield n[0];LoadManager.DOMContentLoaded();yield n[1];LoadManager.load()})}static DOMContentLoaded(){for(var n of LoadManager.Items)n.IsReady||(n.Ready(),n._IsReady=!0)}static load(){for(var n of LoadManager.Items)n.IsLoaded||(n.Load(),n._IsLoaded=!0)}static RaiseUnLoad(){for(var n of LoadManager.Items)n.UnLoadGlobal(),n._IsLoaded=!1,n._IsReady=!1}static RaiseReady(){Prism.highlightAll();LoadManager.DOMContentLoaded()}static RaiseLoad(){LoadManager.load()}UnLoadGlobal(){this.PreUnLoad();for(var n of this.Listeners)n[3]&&n[3](n[0]),n[0].removeEventListener(n[1],n[2]);this.AfterUnLoad();this.Listeners=[]}get IsReady(){return this._IsReady}get IsLoaded(){return this._IsLoaded}addListener(n,t,i,r){n.addEventListener(t,i);this.Listeners.push([n,t,i,r])}static AddItem(n){LoadManager.Items.push(n)}}LoadManager.Items=[];LoadManager.Init();LoadManager.AddItem(new(class extends LoadManager{Ready(){var o=document.getElementById("article"),e,u,f;if(o!==null){var t=document.getElementById("img-checkbox"),i=document.getElementById("img-overlay").lastChild,n,r,h=u=>{r=u,n=document.createElement("div"),n.classList.add("dumy-img"),u.parentNode.insertBefore(n,u),u.parentNode.removeChild(u),i.appendChild(u),t.checked=!0},s=this.close=()=>{r&&(i.removeChild(r),n.parentNode.insertBefore(r,n),n.parentNode.removeChild(n),r=null,n=null,t.checked=!1)};for(this.PreUnLoadFuncs.push(s),this.addListener(t,"change",()=>{console.log(`change=${t.checked}`),t.checked||s()}),this.addListener(i,"click",()=>{i.classList.toggle("raw-size")}),e=o.querySelectorAll("img"),u=0;u<e.length;u++)(f=e[u],f.parentElement.tagName.toLowerCase()!="a")&&(f.classList.add("clickable"),this.addListener(f,"click",function(n){console.log(`click=${t.checked}`);t.checked?i.classList.toggle("raw-size"):h(this);n.stopPropagation()},n=>n.classList.remove("clickable")))}}Load(){}PreUnLoad(){this.close&&this.close()}AfterUnLoad(){}}));class AwaitUtil{static Immidiate(){return new Promise(n=>setTimeout(n,0))}static AnimationFrame(){return new Promise(n=>requestAnimationFrame(()=>n()))}static Timeout(n){return new Promise(t=>setTimeout(t,n))}}class Awaiter{static CreateCompleted(n){let t=new Awaiter;return t.SetResult(n),t}static CreateFailed(n){let t=new Awaiter;return t.ThrowError(n),t}constructor(){this.isDone=!1;this.hasError=!1;this.resolve=null;this.reject=null;this.task=new Promise((n,t)=>{this.isDone?this.hasError?t(this.reason):n(this.result):(this.resolve=n,this.reject=t)})}SetResult(n){this.isDone||(this.isDone=!0,this.result=n,this.resolve&&this.resolve(n))}ThrowError(n){this.isDone||(this.isDone=!0,this.hasError=!0,this.reason=n,this.reject&&this.reject(n))}}class AsyncXHR{constructor(){this.sended=!1;this._headersReceived=new Awaiter;this._loading=new Awaiter;this._done=new Awaiter;this._xhr=new XMLHttpRequest}set responseType(n){this._xhr.responseType=n}get response(){return this._xhr.response}get statusCode(){return this._xhr.status}get statusText(){return this._xhr.statusText}send(n){this.sended||(this.sended=!0,this._xhr.addEventListener("readystatechange",this.ReadyStateChanged.bind(this)),this._xhr.addEventListener("load",this.Load.bind(this)),this._xhr.addEventListener("error",this.Error.bind(this)),this._xhr.addEventListener("abort",this.Abort.bind(this)),this._xhr.addEventListener("timeout",this.Timeout.bind(this)),this._xhr.send(n))}open(n,t){this._xhr.open(n,t,!0)}abort(){this._xhr.abort()}ReadyStateChanged(){switch(this._xhr.readyState){case 2:this._headersReceived.SetResult(this._xhr.status);break;case 3:this._loading.SetResult(undefined)}}Load(){this._done.SetResult(undefined)}Error(){let n="リクエストエラー";this._headersReceived.ThrowError(n);this._loading.ThrowError(n);this._done.ThrowError(n)}Abort(){let n="キャンセルされました";this._headersReceived.ThrowError(n);this._loading.ThrowError(n);this._done.ThrowError(n)}Timeout(){let n="タイムアウト";this._headersReceived.ThrowError(n);this._loading.ThrowError(n);this._done.ThrowError(n)}HeadersReceived(){return this._headersReceived.task}Loading(){return this._loading.task}Done(){return this._done.task}}class TimeoutException extends Error{}class TaskTimeout{constructor(n,t){this._done=!1;this._targetTask=n;t<0?this.task=this._targetTask:(this.task=new Promise((n,t)=>{this._resolve=n,this._reject=t}),n.then(n=>{this._done||(this._done=!0,clearTimeout(this._timeoutId),this._resolve(n))}).catch(n=>{this._done||(this._done=!0,clearTimeout(this._timeoutId),this._reject(n))}),this._timeoutId=setTimeout(()=>{this._done||(this._done=!0,this._reject(new TimeoutException))},t))}}(function(n){n[n.Cold=0]="Cold";n[n.Removed=1]="Removed";n[n.Replaced=2]="Replaced"})(MoveState||(MoveState={}));history.pushState!==undefined&&window.onpopstate!==undefined&&LoadManager.AddItem(new(class extends LoadManager{constructor(){super();this.oldPathName=document.location.pathname;this.moveState=MoveState.Cold;this.canceller=null;this.sharedAnchorElements=undefined;this.temporaryAnchorElements=new Set;this.stack=[];window.addEventListener("popstate",()=>{this.Move()})}CancelTask(){var t,n,i;for(console.debug("Canceled"),t=this.stack.length,n=0;n<t;n++)i=this.stack.shift(),i.SetResult(this.stack.length==0)}Move(){return __awaiter(this,void 0,void 0,function*(){var l=this.oldPathName,f=document.location.pathname,e,n,i,o,r,h,c,u,s;if((this.oldPathName=f,f!==l)&&(console.debug("Requested"),this.moveState===MoveState.Cold||(console.debug("Cancel Requested"),e=new Awaiter,this.stack.push(e),this.canceller(),yield e.task))){console.debug("Started");n=new AsyncXHR;n.responseType="document";n.open("GET",f);try{n.send();this.moveState!=MoveState.Removed?(LoadManager.RaiseUnLoad(),this.Remove(),this.loaderMessage.innerText="",this.loader.classList.add("progress-active"),console.debug("Removed")):console.debug("Remove Skipped");this.loader.classList.remove("reload-active");this.loader.classList.remove("center-active");this.loader.classList.remove("message-active");this.moveState=MoveState.Removed;try{{let t=AttachCanceller(new TaskTimeout(n.HeadersReceived(),1500).task);this.canceller=t[0];let i=yield t[1];if(!i[0]){this.CancelTask();return}}{let t=AttachCanceller(new TaskTimeout(n.Done(),5e3).task);this.canceller=t[0];let i=yield t[1];if(!i[0]){this.CancelTask();return}}}catch(t){this.loader.classList.add("reload-active");this.loader.classList.add("message-active");this.loaderMessage.innerText=t instanceof TimeoutException?"読み込みに時間がかかっています":t}try{{let t=AttachCanceller(n.HeadersReceived());this.canceller=t[0];let i=yield t[1];if(!i[0]){this.CancelTask();return}console.debug("HeaderReceived");yield n.Done();console.debug("XHR Done")}{let t=AttachCanceller(n.Done());this.canceller=t[0];let i=yield t[1];if(!i[0]){this.CancelTask();return}console.debug("Downloaded")}}catch(t){if(t instanceof TimeoutException)throw["Timeout","タイムアウトしました"];else throw["Error",t];}i=n.response;{let n=AttachCanceller(DOMEventsAsync(i)[0]);this.canceller=n[0];let t=yield n[1];if(!t[0]){this.CancelTask();return}}{let r=this.Replace(i);if(!r)if(200<=n.statusCode&&n.statusCode<300)throw["Error","コンテンツが不正でした"];else{console.debug("HeaderError");throw["Error",n.statusText];}o=this.Insert(i);LoadManager.RaiseReady();this.moveState=MoveState.Replaced;console.debug("Replaced");let t=AttachCanceller(DoEvents());this.canceller=t[0];let u=yield t[1];if(!u[0]){this.CancelTask();return}}for(console.debug("Loading"),r=0;r<o.length;r++)for(h=o[r],c=h.getElementsByTagName("img"),u=0;u<length;u++)if(s=c[u],!s.complete){let n=AttachCanceller(EventAsync(s,"load"));this.canceller=n[0];let t=yield n[1];if(!t[0]){this.CancelTask();return}}LoadManager.RaiseLoad();this.moveState=MoveState.Cold;this.canceller=null;console.debug("Loaded")}catch(t){this.moveState=MoveState.Cold;this.canceller=null;Array.isArray(t)?(this.centerInfo.innerText=t[0],this.loaderMessage.innerText=t[1]):(this.centerInfo.innerText="ERROR",this.centerInfo.innerText=t);this.loader.classList.remove("progress-active");this.loader.classList.add("center-active");this.loader.classList.add("message-active");this.loader.classList.add("reload-active");console.error(t)}}})}Remove(){var n=document.querySelectorAll("meta[data-start]");for(let n of n){let i=n.getAttribute("data-start"),t=n.nextSibling;while(!(t instanceof Element)||t.getAttribute("data-end")!==i){let n=t.nextSibling;t.remove();t=n}}}Replace(n){var r=document.querySelectorAll("[data-replace]"),u=n.querySelectorAll("[data-replace]"),t=new Map,i=new Map;for(let n of r){let i=n.getAttribute("data-replace"),r=t.get(i);if(r===undefined)t.set(i,n);else return console.error("Multiple data-ajax"),!1}for(let n of u){let t=n.getAttribute("data-replace"),r=i.get(t);if(r===undefined)i.set(t,n);else return console.error("Multiple data-ajax"),!1}for(let[n,t]of t){let r=i.get(n);if(r===undefined)return console.error("data-ajax Only Old Element"),!1;let i=n.split("-")[1];if(i==="innerHTML")t.innerHTML=r.innerHTML;else{let n=r.getAttribute(i);n===null&&(n="");t.setAttribute(i,n)}}return!0}Insert(n){for(var u,f,i,e,c,t,l,a,o=[],s=document.querySelectorAll("meta[data-start]"),h=n.querySelectorAll("meta[data-start]"),r=0;r<s.length;r++)for(u=s[r],f=u.nextElementSibling,i=0;i<h.length;i++)if(e=h[i],c=u.getAttribute("data-start"),c===e.getAttribute("data-start")){for(t=e.nextSibling;t!==null;){if(t instanceof HTMLElement){if(l=t,l.matches("meta[data-end]"))break;o.push(t)}a=t.nextSibling;t.parentElement.removeChild(t);f.parentElement.insertBefore(t,f);t=a}break}return o}anchorClick(n,t){history.pushState({},"",n.href);this.Move();t.preventDefault()}Ready(){const t="a[href^='/']";this.progress=document.querySelector("#loader>.progress-ring");this.loader=document.getElementById("loader");this.centerInfo=document.getElementById("center-info");this.loaderInfo=document.getElementById("loader-info");this.loaderMessage=document.getElementById("loader-message");let n=new Set;var i=document.querySelectorAll("meta[data-start]");for(let i of i){let u=i.getAttribute("data-start"),r=i.nextElementSibling;while(r.getAttribute("data-end")!=u){let i=r.querySelectorAll(t);for(let t of i)this.addListener(t,"click",this.anchorClick.bind(this,t)),n.add(t);r=r.nextElementSibling}}if(this.sharedAnchorElements===undefined){let i=new Set,r=document.querySelectorAll(t);for(let t of r)n.has(t)||(t.addEventListener("click",this.anchorClick.bind(this,t)),i.add(t));this.sharedAnchorElements=i}this.temporaryAnchorElements=n}Load(){}PreUnLoad(){var n=document.getElementById("menu-checkbox");n.checked&&(n.checked=!1)}AfterUnLoad(){}}));LoadManager.AddItem(new(class extends LoadManager{Ready(){var n=document.getElementById("toc"),i;if(n!=null){var r=n.parentElement,u=document.getElementById("main")||document,t=null;const f=8;i=()=>{var i,o,s,h,e,l;if(window.getComputedStyle(n).position==="sticky"){var c=r.getBoundingClientRect(),a=Math.max(c.top,f),v=Math.min(c.bottom,window.innerHeight-f);for(n.style.maxHeight=v-a+"px",i=null,o=u.querySelectorAll("h1,h2,h3,h4,h5,h6"),o.length&&(i=o[0]),s=1;s<o.length;s++)if(h=o[s],h.getBoundingClientRect().top<=f)i=h;else break;i!==null&&i.id?t!==i.id&&(t!==null&&n.querySelector("a.current").classList.remove("current"),t=i.id,e=n.querySelector(`a[href="#${encodeURI(i.id)}"]`),e&&e.classList.add("current")):(t!==null&&n.querySelector("a.current").classList.remove("current"),t=null);t!==null&&(e=n.querySelector(`a[href="#${encodeURI(i.id)}"]`),e&&(l=e.offsetTop+e.scrollTop+e.clientHeight/2,n.scrollTop=l-n.clientHeight/2))}else n.style.maxHeight=null,t!==null&&(t=null,n.querySelector("a.current").classList.remove("current"))};this.addListener(window,"resize",i);this.addListener(window,"scroll",i);i()}}Load(){}PreUnLoad(){}AfterUnLoad(){}}));